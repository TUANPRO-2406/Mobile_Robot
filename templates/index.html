<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <!-- ĐÃ SỬA: Thêm user-scalable=no, maximum-scale=1.0 để vô hiệu hóa zoom -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Điều Khiển Mobile Robot - HTTP/REST</title>
    <!-- Nhúng CSS tùy chỉnh -->
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<!-- ĐÃ SỬA: oncontextmenu="return false;" để chặn hộp thoại ngữ cảnh khi nhấn giữ -->

<body oncontextmenu="return false;">
    <div class="container">
        <!-- TIÊU ĐỀ và BẢNG TRẠNG THÁI -->
        <div class="header-area">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1>Web Điều Khiển Robot</h1>
                <div>
                    <a href="/history" style="text-decoration: none; margin-right: 10px;">
                        <button style="padding: 5px 10px; cursor: pointer;">Lịch Sử</button>
                    </a>
                    <a href="/logout" style="text-decoration: none;">
                        <button
                            style="padding: 5px 10px; cursor: pointer; background: #dc3545; color: white; border: none; border-radius: 4px;">Đăng
                            xuất</button>
                    </a>
                </div>
            </div>

            <div class="status-panel">
                <div class="status-header">
                    <p>Chế độ: <strong id="current-mode">MANUAL</strong></p>
                    <p>Khí gas: <strong id="current-gas-display" style="color: green;">0</strong></p>
                    <p>Tốc độ: <strong id="current-speed-display">0</strong></p>
                </div>
                <p id="message-log"></p>

                <div class="toggle-speed-group">
                    <button id="mode-toggle-btn" class="mode-manual">Chế độ tự động</button>
                    <!-- Thanh trượt tốc độ -->
                    <div class="speed-control">
                        <span>Tốc độ: <span id="slider-value">0</span>/255</span>
                        <input type="range" min="0" max="255" value="0" class="slider" id="speed-slider">
                    </div>
                </div>
            </div>
        </div>

        <!-- BẢNG ĐIỀU KHIỂN HƯỚNG ĐI -->
        <div class="control-area">
            <h2>Bảng Điều Khiển</h2>
            <div class="control-pad" id="manual-controls">
                <div class="row">
                    <img src="/static/images/tuan.jpg" class="control-img" alt="Tiến"
                        onmousedown="send_command_post('FORWARD')" ontouchstart="send_command_post('FORWARD')"
                        onmouseup="send_command_post('STOP')" ontouchend="send_command_post('STOP')">
                </div>
                <div class="row">
                    <img src="/static/images/thun.jpg" class="control-img" alt="Trái"
                        onmousedown="send_command_post('LEFT')" ontouchstart="send_command_post('LEFT')"
                        onmouseup="send_command_post('STOP')" ontouchend="send_command_post('STOP')">

                    <img src="/static/images/beu.jpg" class="control-img stop-img" alt="Dừng"
                        onclick="send_command_post('STOP')">

                    <img src="/static/images/hin.jpg" class="control-img" alt="Phải"
                        onmousedown="send_command_post('RIGHT')" ontouchstart="send_command_post('RIGHT')"
                        onmouseup="send_command_post('STOP')" ontouchend="send_command_post('STOP')">
                </div>
                <div class="row">
                    <img src="/static/images/dieu.jpg" class="control-img" alt="Lùi"
                        onmousedown="send_command_post('BACKWARD')" ontouchstart="send_command_post('BACKWARD')"
                        onmouseup="send_command_post('STOP')" ontouchend="send_command_post('STOP')">
                </div>
            </div>
        </div>
    </div>

    <script>
        const speedSlider = document.getElementById('speed-slider');
        const sliderValueDisplay = document.getElementById('slider-value');
        const currentSpeedDisplay = document.getElementById('current-speed-display');
        const currentModeDisplay = document.getElementById('current-mode');
        const modeToggleBtn = document.getElementById('mode-toggle-btn');
        const manualControls = document.getElementById('manual-controls');
        const messageLog = document.getElementById('message-log');

        async function post_data(url, data = {}) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (response.ok) {
                    if (result.mode) {
                        update_status_ui(result.mode);
                    }
                    messageLog.textContent = `Server: ${result.message || 'OK'}`;
                } else {
                    messageLog.textContent = `Lỗi: ${result.message}`;
                }
            } catch (error) {
                messageLog.textContent = `Lỗi kết nối Server: ${error.message}`;
                console.error('Error:', error);
            }
        }

        function send_command_post(command) {
            if (currentModeDisplay.textContent === "MANUAL") {
                post_data('/command', { command: command });
            } else {
                messageLog.textContent = "Robot đang ở chế độ Tự động.";
            }
        }

        speedSlider.addEventListener('change', (event) => {
            const speed = event.target.value;
            sliderValueDisplay.textContent = speed;
            currentSpeedDisplay.textContent = speed;
            post_data(`/speed/${speed}`);
        });

        modeToggleBtn.addEventListener('click', () => {
            post_data('/mode');
        });

        function update_status_ui(new_mode) {
            currentModeDisplay.textContent = new_mode;
            if (new_mode === "MANUAL") {
                modeToggleBtn.textContent = "Chuyển sang Tự động";
                modeToggleBtn.className = "mode-manual";
                manualControls.style.opacity = "1";
                manualControls.style.pointerEvents = "auto";
            } else {
                modeToggleBtn.textContent = "Chuyển sang Điều khiển";
                modeToggleBtn.className = "mode-auto";
                manualControls.style.opacity = "0.5";
                manualControls.style.pointerEvents = "none";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            sliderValueDisplay.textContent = speedSlider.value;
            currentSpeedDisplay.textContent = speedSlider.value;
        });

    </script>
</body>

</html>